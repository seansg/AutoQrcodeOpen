import subprocess
import sys
import os

# --- è‡ªå‹•æª¢æŸ¥ä¸¦å®‰è£å¥—ä»¶çš„é‚è¼¯ ---
def install_requirements():
    requirements = ['opencv-python', 'pyzbar', 'pyautogui', 'pyobjc-framework-Quartz', 'numpy']
    
    # æª¢æŸ¥ zbar ç³»çµ±å·¥å…· (macOS å°ˆç”¨)
    if subprocess.run(["brew", "--version"], capture_output=True).returncode != 0:
        print("âŒ åµæ¸¬åˆ°æœªå®‰è£ Homebrewï¼Œè«‹å…ˆè‡³ https://brew.sh å®‰è£ï¼Œæ‰èƒ½è‡ªå‹•å®‰è£ zbar å¼•æ“ã€‚")
        return False

    try:
        import cv2, pyzbar, pyautogui, Quartz
        print("âœ… æ‰€æœ‰å¥—ä»¶å·²å°±ç·’ã€‚")
    except ImportError:
        print("ğŸ“¦ æ­£åœ¨å®‰è£ç¼ºå¤±çš„å¥—ä»¶ï¼Œè«‹ç¨å€™...")
        subprocess.check_call([sys.executable, "-m", "pip", "install"] + requirements)
        # é¡å¤–å®‰è£ zbar ç³»çµ±å±¤ç´šå·¥å…·
        subprocess.run(["brew", "install", "zbar"], capture_output=True)
        print("âœ… å®‰è£å®Œæˆï¼")
    return True

# --- æ ¸å¿ƒ QR Code ç›£æ¸¬é‚è¼¯ ---
def start_monitor():
    import pyautogui
    import cv2
    from pyzbar.pyzbar import decode
    import webbrowser
    import time
    import numpy as np
    import Quartz

    def get_window_rect(app_name):
        windows = Quartz.CGWindowListCopyWindowInfo(Quartz.kCGWindowListOptionOnScreenOnly, Quartz.kCGNullWindowID)
        for window in windows:
            name = window.get('kCGWindowOwnerName', '')
            if app_name.lower() in name.lower():
                bounds = window.get('kCGWindowBounds', {})
                # æ³¨æ„ï¼šRetina è¢å¹•å¯èƒ½éœ€è¦è™•ç†åº§æ¨™å€ç‡å•é¡Œ
                return (int(bounds['X']), int(bounds['Y']), int(bounds['Width']), int(bounds['Height']))
        return None

    last_scanned_url = ""
    print(f"\nğŸš€ LINE è‡ªå‹•åµæ¸¬å•Ÿå‹•ä¸­...")
    print("ğŸ“¢ æç¤ºï¼šè«‹ç¢ºä¿ LINE è¦–çª—æœªè¢«å®Œå…¨é®æ“‹ã€‚æŒ‰ Ctrl+C å¯åœæ­¢ã€‚")

    try:
        while True:
            rect = get_window_rect("LINE")
            if rect:
                # æˆªå– LINE è¦–çª—
                screenshot = pyautogui.screenshot(region=rect)
                frame = cv2.cvtColor(np.array(screenshot), cv2.COLOR_RGB2BGR)
                qr_codes = decode(frame)
                
                for qr in qr_codes:
                    url = qr.data.decode('utf-8')
                    if url != last_scanned_url:
                        print(f"ğŸ”— ç™¼ç¾æ–°é€£çµ: {url}")
                        webbrowser.open(url)
                        last_scanned_url = url
            time.sleep(2)
    except KeyboardInterrupt:
        print("\nğŸ›‘ å·²åœæ­¢åµæ¸¬ã€‚")

if __name__ == "__main__":
    if install_requirements():
        start_monitor()
